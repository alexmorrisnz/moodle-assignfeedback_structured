define(["jquery","core/ajax","core/notification","core/str","core/templates","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g){function h(d,e){var f=d.getRoot(),g=f.find('[name="criteriaset-name"]').val().trim(),h=f.find('[name="criteriaset-publish"]').prop("checked"),i=f.find(".loading");i.removeClass("hidden");var j=[];f.parent().find('[id^="id_assignfeedback_structured_critname"]').each(function(){if(a(this).val().trim().length){var b=a(this).parent().parent().next().find('[id^="id_assignfeedback_structured_critdesc"]');j.push({name:a(this).val().trim(),description:b.val().trim()})}});var k=b.call([{methodname:"assignfeedback_structured_save_criteriaset",args:{contextid:e,name:g,criteria:j,"public":h}}]);k[0].done(function(a){a.hide===!0&&d.hide(),c.alert(a.title,a.body,a.label)}).fail(c.exception).always(function(){i.addClass("hidden")})}var i,j={init:function(b,j){var k="";d.get_string("criteriasetsave","assignfeedback_structured").then(function(d){k=d;var l={canPublish:j},m=e.render("assignfeedback_structured/criteriasetsave",l);if(i)i.setBody(m),i.show();else{var n=a("#id_assignfeedback_structured_critsetsave");f.create({title:k,body:m,type:f.types.SAVE_CANCEL,large:!1},n).done(function(a){i=a,n.click(function(){i.show()}),a.getRoot().on(g.save,function(c){c.preventDefault(),h(a,b)}),a.getRoot().on(g.hidden,function(){c.fetchNotifications()})})}})}};return j});