define(["jquery","core/ajax","core/notification","core/str","core/templates","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g){function h(d,e){var f=d.getRoot(),g=f.find('[name="criteriaset-name"]').val().trim(),h=f.find('[name="criteriaset-publish"]').prop("checked"),i=f.find(".loading");i.removeClass("hidden");var j=[];f.parent().find('[id^="id_assignfeedback_structured_critname"]').each(function(){if(a(this).val().trim().length){var b=a(this).parent().parent().next().find('[id^="id_assignfeedback_structured_critdesc"]');j.push({name:a(this).val().trim(),description:b.val().trim()})}});var k=b.call([{methodname:"assignfeedback_structured_save_criteriaset",args:{contextid:e,name:g,criteria:j,"public":h}}]);k[0].done(function(a){a.hide===!0&&d.hide(),c.alert(a.title,a.body,a.label)}).fail(c.exception).always(function(){i.addClass("hidden")})}var i,j={init:function(b,c){var j="";d.get_string("criteriasetsave","assignfeedback_structured").then(function(d){j=d;var k={canPublish:c},l=e.render("assignfeedback_structured/criteriasetsave",k);if(i)i.setBody(l),i.show();else{var m=a("#id_assignfeedback_structured_critsetsave");f.create({title:j,body:l,type:f.types.SAVE_CANCEL,large:!1},m).done(function(c){i=c,m.click(function(){i.show()}),c.getRoot().on(g.save,function(a){a.preventDefault(),h(c,b)}),c.getRoot().on(g.hidden,function(){a(this).find('[name="criteriaset-name"]').val(""),a(this).find('[name="criteriaset-publish"]').prop("checked",!1)})})}})}};return j});